{
    "variables": {
        "packer_cache_dir": "{{env `PACKER_CACHE_DIR`}}",
        "target": "{{env `PACKER_TARGET`}}",
        "base_version": "{{env `PACKER_BASE_VERSION`}}",
        "arch": "{{env `PACKER_ARCH`}}",
        "headless": "{{env `PACKER_HEADLESS`}}",
        "target_version": "{{env `PACKER_TARGET_VERSION`}}"
    },

    "builders": [
        {
            "name": "srv.qemu",
            "type": "qemu",
            "accelerator": "kvm",
            "vm_name": "alt-server-{{user `target_version`}}-{{user `arch`}}",
            "disk_size": 30000,
            "disk_cache": "unsafe",
            "output_directory": "output-srv.qemu",
            "headless": "{{user `headless`}}",
            "qemuargs": [
                [ "-m", "2048M" ]
            ],

            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_target_path": "{{user `packer_cache_dir`}}/{{user `target`}}-{{user `base_version`}}-{{user `arch`}}.iso",

            "http_port_min": "{{user `http_port_min`}}",
            "http_port_max": "{{user `http_port_max`}}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "2s",
            "boot_command": [
		"<esc><wait><enter><wait>",
		"alt0/vmlinuz initrd=alt0/full.cz changedisk ramdisk_size=239301 lang=ru_RU noeject quiet=1 showopts net.ifnames=0 automatic=method:http,network:dhcp,server:{{user `iso_address`}},directory:{{user `iso_dir`}} ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/srv/kvm/",
		"<wait><enter>"
            ],

            "shutdown_command": "sudo shutdown -P now"
        },

        {
            "name": "srv.vbox",
            "type": "virtualbox-iso",
            "guest_os_type": "Linux_64",
            "vm_name": "alt-server-{{user `target_version`}}-{{user `arch`}}",
            "disk_size": 30000,
            "output_directory": "output-srv.vbox",
            "headless": "{{user `headless`}}",
            "keep_registered": false,
            "guest_additions_mode": "disable",
            "vboxmanage": [
                ["modifyvm", "{{.Name}}", "--memory", "2048"],
                ["modifyvm", "{{.Name}}", "--cpus", "1"]
            ],

            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_target_path": "{{user `packer_cache_dir`}}/{{user `target`}}-{{user `base_version`}}-{{user `arch`}}.iso",

            "http_port_min": "{{user `http_port_min`}}",
            "http_port_max": "{{user `http_port_max`}}",

            "ssh_username": "{{ user `vagrant_user` }}",
            "ssh_password": "{{ user `vagrant_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "5s",
            "boot_command": [
                "<esc><wait><enter><wait>",
                "alt0/vmlinuz initrd=alt0/full.cz changedisk ramdisk_size=239301 lang=ru_RU noeject quiet=1 showopts net.ifnames=0 automatic=method:http,network:dhcp,server:{{user `iso_address`}},directory:{{user `iso_dir`}} ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/srv/vbox/",
                "<wait><enter>"
            ],

            "shutdown_command": "sudo shutdown -P now",
            "post_shutdown_delay": "10s",

            "export_opts":
            [
                "--manifest",
                "--vsys", "0",
                "--description", "ALT Server P8 x86_64",
                "--version", "{{ user `target_version` }}"
            ],

            "format": "ova"
        },

        {
            "name": "kws.qemu",
            "type": "qemu",
            "accelerator": "kvm",
            "vm_name": "alt-kworkstation-{{user `target_version`}}-{{user `arch`}}",
            "disk_size": 30000,
            "disk_cache": "unsafe",
            "output_directory": "output-kw",
            "headless": "{{user `headless`}}",
            "qemuargs": [
                [ "-m", "2048M" ]
            ],

            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_target_path": "{{user `packer_cache_dir`}}/{{user `target`}}-{{user `base_version`}}-{{user `arch`}}.iso",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_port_min": "{{user `http_port_min`}}",
            "http_port_max": "{{user `http_port_max`}}",
            "http_directory": "./",

            "boot_wait": "2s",
            "boot_command": [
                "<esc><wait><enter><wait>",
                "alt0/vmlinuz initrd=alt0/full.cz changedisk ramdisk_size=239301 lang=ru_RU noeject quiet=1 showopts net.ifnames=0 automatic=method:http,network:dhcp,server:{{user `iso_address`}},directory:{{user `iso_dir`}} ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/kws/kvm/",
                "<wait><enter>"
            ],

            "shutdown_command": "sudo shutdown -P now"
        },

        {
            "name": "kws.vbox",
            "type": "virtualbox-iso",
            "guest_os_type": "Linux_64",
            "vm_name": "alt-kworkstaion-{{user `target_version`}}-{{user `arch`}}",
            "disk_size": 30000,
            "output_directory": "output-kw.vbox",
            "headless": "{{user `headless`}}",
            "keep_registered": false,
            "guest_additions_mode": "disable",
            "vboxmanage": [
                ["modifyvm", "{{.Name}}", "--memory", "2048"],
                ["modifyvm", "{{.Name}}", "--cpus", "1"]
            ],

            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_target_path": "{{user `packer_cache_dir`}}/{{user `target`}}-{{user `base_version`}}-{{user `arch`}}.iso",

            "http_port_min": "{{user `http_port_min`}}",
            "http_port_max": "{{user `http_port_max`}}",

            "ssh_username": "{{ user `vagrant_user` }}",
            "ssh_password": "{{ user `vagrant_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "5s",
            "boot_command": [
                "<esc><wait><enter><wait>",
                "alt0/vmlinuz initrd=alt0/full.cz changedisk ramdisk_size=239301 lang=ru_RU noeject quiet=1 showopts net.ifnames=0 automatic=method:http,network:dhcp,server:{{user `iso_address`}},directory:{{user `iso_dir`}} ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/kws/vbox/",
                "<wait><enter>"
            ],

            "shutdown_command": "sudo shutdown -P now",
            "post_shutdown_delay": "10s",

            "export_opts":
            [
                "--manifest",
                "--vsys", "0",
                "--description", "ALT KWorkstation P8 x86_64",
                "--version", "{{ user `target_varsion` }}"
            ],

            "format": "ova"
        },


        {
            "name": "ws.qemu",
            "type": "qemu",
            "accelerator": "kvm",
            "vm_name": "alt-workstation-{{user `target_version`}}-{{user `arch`}}",
            "disk_size": 30000,
            "disk_cache": "unsafe",
            "output_directory": "output-ws",
            "headless": "{{user `headless`}}",
            "qemuargs": [
                [ "-m", "2048M" ]
            ],

            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_target_path": "{{user `packer_cache_dir`}}/{{user `target`}}-{{user `base_version`}}-{{user `arch`}}.iso",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_port_min": "{{user `http_port_min`}}",
            "http_port_max": "{{user `http_port_max`}}",
            "http_directory": "./",

            "boot_wait": "2s",
            "boot_command": [
                "<esc><wait><enter><wait>",
                "alt0/vmlinuz initrd=alt0/full.cz changedisk ramdisk_size=239301 lang=ru_RU noeject quiet=1 showopts net.ifnames=0 automatic=method:http,network:dhcp,server:{{user `iso_address`}},directory:{{user `iso_dir`}} ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/ws/kvm/",
                "<wait><enter>"
            ],

            "shutdown_command": "sudo shutdown -P now"
        },

        {
            "name": "ws.vbox",
            "type": "virtualbox-iso",
            "guest_os_type": "Linux_64",
            "vm_name": "alt-workstaion-{{user `target_version`}}-{{user `arch`}}",
            "disk_size": 30000,
            "output_directory": "output-ws.vbox",
            "headless": "{{user `headless`}}",
            "keep_registered": false,
            "guest_additions_mode": "disable",
            "vboxmanage": [
                ["modifyvm", "{{.Name}}", "--memory", "2048"],
                ["modifyvm", "{{.Name}}", "--cpus", "1"]
            ],

            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_target_path": "{{user `packer_cache_dir`}}/{{user `target`}}-{{user `base_version`}}-{{user `arch`}}.iso",

            "http_port_min": "{{user `http_port_min`}}",
            "http_port_max": "{{user `http_port_max`}}",

            "ssh_username": "{{ user `vagrant_user` }}",
            "ssh_password": "{{ user `vagrant_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "5s",
            "boot_command": [
                "<esc><wait><enter><wait>",
                "alt0/vmlinuz initrd=alt0/full.cz changedisk ramdisk_size=239301 lang=ru_RU noeject quiet=1 showopts net.ifnames=0 automatic=method:http,network:dhcp,server:{{user `iso_address`}},directory:{{user `iso_dir`}} ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/ws/vbox/",
                "<wait><enter>"
            ],

            "shutdown_command": "sudo shutdown -P now",
            "post_shutdown_delay": "10s",

            "export_opts":
            [
                "--manifest",
                "--vsys", "0",
                "--description", "ALT Workstation P8 x86_64",
                "--version", "{{ user `target_version` }}"
            ],

            "format": "ova"
        }

    ],

    "provisioners": [
        {
            "type": "shell",
            "script": "scripts/fix_sudoers.sh",
            "environment_vars": [
                "PASS='{{user `ssh_pass`}}'"
            ]
        },
        {
            "type": "file",
            "source": "scripts/",
            "destination": "/tmp/"
        },
        {
            "type": "shell",
            "script": "scripts/disable_repos.sh"
        },
        {
            "type": "shell",
            "inline": [
                "sudo curl http://${PACKER_HTTP_ADDR}/scripts/srt.basealt.ru-{{user `target_version`}}-{{user `arch`}}.list -o /etc/apt/sources.list.d/srt.basealt.ru-{{user `target_version`}}-{{user `arch`}}.list"
            ]
        },
        {
            "type": "shell",
            "execute_command": "sudo sh -c '{{ .Vars }} {{ .Path }}'",
            "inline": [
                "mv /tmp/rc.apt /etc/rc.d/scripts/apt-cache-on-tmp",
                "mv /tmp/rc.local /etc/rc.d/rc.local",
                "mv /tmp/tmp.cache.conf /etc/apt/apt.conf.d/tmp.cache.conf",
                "/etc/rc.d/scripts/apt-cache-on-tmp",
                "apt-get -q clean",
                "apt-get -qy update",
                "apt-get -qy dist-upgrade",
                "apt-get install -qy qemu-guest-agent cloud-init udev-rule-generator-net",
                "systemctl enable qemu-guest-agent",
                "systemctl disable cloud-init"
            ]
        },
        {
            "type": "shell",
            "inline": "sudo rm -f /etc/apt/sources.list.d/sources.installer.list"
        },
        {
            "type": "shell",
            "inline": [
                "mkdir -p ${HOME}/.ssh",
                "curl http://${PACKER_HTTP_ADDR}/pubkeys/vagrant.pub -o ${HOME}/.ssh/authorized_keys"
            ],
            "only": ["srv.vbox", "kws.vbox", "ws.vbox"]
        },
        {
            "type": "shell",
            "inline": [
                "sudo curl http://${PACKER_HTTP_ADDR}/pubkeys/robot.pub -o /etc/openssh/authorized_keys/root"
            ],
            "only": ["srv.qemu", "kws.qemu", "ws.qemu"]
        },
        {
            "type": "shell",
            "inline": [
                "mkdir -p ${HOME}/.ssh",
                "sudo curl http://${PACKER_HTTP_ADDR}/scripts/81-net-hotplug.rules -o /etc/udev/rules.d/81-net-hotplug.rules"
            ]
        },
        {
            "type": "shell",
            "inline": [
                "sudo rm -rf /etc/net/ifaces/ens3",
                "sudo sed -i 's/ALLOW_UNKNOWN=off/ALLOW_UNKNOWN=yes/' /etc/net/options.d/50-ALTLinux-server"
            ],
            "only": ["srv.qemu"]
        },
        {
            "type": "shell",
            "script": "scripts/install-guest-tools.sh",
            "environment_vars": [
                "SSH_USER='{{user `ssh_user`}}'"
            ],
            "only": ["srv.vbox", "kws.vbox", "ws.vbox"]
        },
        {
            "type": "shell",
            "inline": [
                "sudo rm -f /etc/openssh/ssh_host_*"
            ]
        }
    ],
    "post-processors": [
        {
            "type": "checksum",
            "checksum_types": [ "md5", "sha1" ],
            "output": "results/{{.BuildName}}.{{.ChecksumType}}"
        },
        {
            "type": "vagrant",
            "only": [ "srv.vbox", "kws.vbox", "ws.vbox" ],
            "output": "results/{{.BuildName}}.box"
        },
        {
            "type": "compress",
            "output": "results/{{.BuildName}}.tar.gz",
            "only": [ "srv.qemu", "kws.qemu", "ws.qemu" ]
        },
        {
            "type": "manifest",
            "output": "results/manifest.json",
            "strip_path": true
        }
    ]
}
